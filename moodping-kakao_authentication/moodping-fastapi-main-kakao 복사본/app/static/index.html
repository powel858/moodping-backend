<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodPing - ë§ˆìŒì„ ê¸°ë¡í•˜ë‹¤</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav-bar">
            <a href="/" class="nav-logo">Mood<span>Ping</span></a>
            <div class="nav-actions" id="nav-actions"></div>
        </nav>

        <!-- Hero Section -->
        <div class="hero">
            <span class="hero-emoji">ğŸŒ™</span>
            <h1>ë‹¹ì‹ ì˜ ë§ˆìŒì—<br>ê·€ ê¸°ìš¸ì´ëŠ” ê³µê°„</h1>
            <p>ê°ì •ì„ ê¸°ë¡í•˜ê³ , AI ìƒë‹´ì‚¬ì˜<br>ë”°ëœ»í•œ ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
        </div>

        <!-- CTA Cards -->
        <div class="card" id="card-record">
            <span class="card-icon">âœï¸</span>
            <h3>ì˜¤ëŠ˜ì˜ ê°ì • ê¸°ë¡í•˜ê¸°</h3>
            <p>ì§€ê¸ˆ ëŠë¼ëŠ” ê°ì •ì„ ì„ íƒí•˜ê³ ,<br>AIì˜ ë§ˆìŒ í¸ì§€ë¥¼ ë°›ì•„ë³´ì„¸ìš”.</p>
            <a href="/record" class="btn-primary" id="start-btn">ê°ì • ê¸°ë¡ ì‹œì‘</a>
        </div>

        <div class="card" id="card-report">
            <span class="card-icon">ğŸ“Š</span>
            <h3>ì´ë²ˆ ì£¼ ë§ˆìŒ ë¦¬í¬íŠ¸</h3>
            <p>ì¼ì£¼ì¼ê°„ì˜ ê°ì • íë¦„ì„ í•œëˆˆì— í™•ì¸í•˜ê³ ,<br>AI ìƒë‹´ì‚¬ì˜ ì£¼ê°„ ë¶„ì„ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
            <a href="/report" class="btn-secondary" id="report-btn">ì£¼ê°„ ë¦¬í¬íŠ¸ ë³´ê¸°</a>
        </div>

        <!-- Kakao Login Prompt (ë¹„ë¡œê·¸ì¸ ì‹œ) -->
        <div class="card hidden" id="card-login">
            <div class="login-prompt">
                <span class="card-icon">ğŸ”</span>
                <p>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì„ í•˜ë©´ ê°ì • ê¸°ë¡ì´<br>ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ê³ , ì£¼ê°„ ë¦¬í¬íŠ¸ë¥¼<br>ë°›ì•„ë³¼ ìˆ˜ ìˆì–´ìš”.</p>
                <a href="/kakao-auth/request-oauth-link" class="btn-kakao-large" id="kakao-login-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M12 3C6.48 3 2 6.58 2 10.94c0 2.8 1.86 5.27 4.66 6.67-.15.56-.96 3.6-.99 3.83 0 0-.02.17.09.23.11.07.24.01.24.01.32-.04 3.7-2.44 4.28-2.86.56.08 1.14.12 1.72.12 5.52 0 10-3.58 10-7.94S17.52 3 12 3z"/></svg>
                    ì¹´ì¹´ì˜¤ë¡œ 3ì´ˆ ë§Œì— ì‹œì‘í•˜ê¸°
                </a>
            </div>
        </div>
    </div>

    <!-- Debug Dashboard -->
    <div class="debug-panel">
        <h4>Debug Dashboard</h4>
        <button class="refresh-btn" onclick="loadDebugData()">ìƒˆë¡œê³ ì¹¨</button>

        <div class="debug-section">
            <div class="label">ìµœê·¼ ê°ì • ê¸°ë¡</div>
            <div id="debug-records">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="debug-section">
            <div class="label">í¼ë„ ì§€í‘œ (ì´íƒˆ ì„ê³„ê°’: 10ë¶„)</div>
            <div id="debug-metrics">ë¡œë”© ì¤‘...</div>
        </div>

        <div class="debug-section">
            <div class="label">ë‹¨ê³„ë³„ ì´íƒˆ ë¶„ì„</div>
            <div id="debug-step-funnel">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            handleTokenFromUrl();
            renderNavAuth(document.getElementById('nav-actions'));
            logEvent('onboarding_view');

            if (!isLoggedIn()) {
                document.getElementById('card-login').classList.remove('hidden');
            }

            document.getElementById('start-btn').addEventListener('click', (e) => {
                e.preventDefault();
                logEvent('record_start_click').then(() => {
                    window.location.href = '/record';
                });
            });

            loadDebugData();
        });

        async function loadDebugData() {
            await loadRecentRecords();
            await loadMetrics();
        }

        async function loadRecentRecords() {
            const el = document.getElementById('debug-records');
            try {
                const res = await fetch('/api/debug/recent-records');
                const data = await res.json();

                if (data.length === 0) {
                    el.innerHTML = '<span style="color:#6c7086">ê¸°ë¡ ì—†ìŒ</span>';
                    return;
                }

                el.innerHTML = data.map(r => `
                    <div class="debug-record-item">
                        <span class="label">ID:</span> <span class="value">${r.record_id}</span>
                        &nbsp;|&nbsp;
                        <span class="value">${r.emoji || ''}</span>
                        <span class="label"> ê°•ë„:</span> <span class="value">${r.intensity}/10</span>
                        <br>
                        <span class="label">ë©”ëª¨:</span> <span class="value">${r.mood_text || '-'}</span>
                        <br>
                        <span class="label">ë¶„ì„:</span> <span class="value">${r.analysis_text ? r.analysis_text.substring(0, 60) + '...' : 'ì—†ìŒ'}</span>
                        <br>
                        <span style="color:#6c7086;font-size:10px">${r.recorded_at || ''} | ${r.anon_id ? 'anon:' + r.anon_id.substring(0, 8) : 'user:' + (r.user_id || '?')}</span>
                    </div>
                `).join('');
            } catch (e) {
                el.innerHTML = '<span style="color:#f38ba8">API ì—°ê²° ì‹¤íŒ¨: ' + e.message + '</span>';
            }
        }

        async function loadMetrics() {
            const el = document.getElementById('debug-metrics');
            const stepEl = document.getElementById('debug-step-funnel');
            try {
                const res = await fetch('/api/debug/metrics');
                const d = await res.json();
                const rf = d.funnel.record_funnel;
                const af = d.funnel.analysis_funnel;
                const ret = d.retention;

                el.innerHTML = `
                    <div style="margin-bottom:6px">
                        <span class="label">[ê¸°ë¡ í¼ë„]</span><br>
                        ì‹œì‘: <span class="value">${rf.record_start_count}</span>ëª… â†’
                        ì™„ë£Œ: <span class="value">${rf.record_complete_count}</span>ëª… |
                        ì´íƒˆë¥ : <span class="value">${(rf.record_drop_rate * 100).toFixed(1)}%</span> |
                        í‰ê· : <span class="value">${rf.avg_record_duration_minutes}ë¶„</span>
                    </div>
                    <div style="margin-bottom:6px">
                        <span class="label">[ë¶„ì„ í¼ë„]</span><br>
                        ì™„ë£Œ: <span class="value">${af.record_complete_count}</span>ëª… â†’
                        ì¡°íšŒ: <span class="value">${af.analysis_view_count}</span>ëª… |
                        ì´íƒˆë¥ : <span class="value">${(af.analysis_drop_rate * 100).toFixed(1)}%</span> |
                        í‰ê· : <span class="value">${af.avg_analysis_duration_minutes}ë¶„</span>
                    </div>
                    <div>
                        <span class="label">[7ì¼ ë¦¬í…ì…˜]</span><br>
                        ëŒ€ìƒ: <span class="value">${ret.total_users}</span>ëª… |
                        ì¬ë°©ë¬¸: <span class="value">${ret.retained_users}</span>ëª… |
                        ìœ ì§€ìœ¨: <span class="value">${ret.retention_rate_percent}%</span>
                    </div>
                `;

                const steps = d.step_funnel || [];
                if (steps.length === 0) {
                    stepEl.innerHTML = '<span style="color:#6c7086">ë°ì´í„° ì—†ìŒ</span>';
                    return;
                }
                const maxSessions = steps[0].sessions || 1;
                stepEl.innerHTML = steps.map((s, i) => {
                    const barWidth = Math.max(2, Math.round((s.sessions / maxSessions) * 100));
                    const dropPct = (s.drop_rate * 100).toFixed(1);
                    const dropColor = s.drop_rate > 0.3 ? '#f38ba8' : s.drop_rate > 0.1 ? '#fab387' : '#a6e3a1';
                    const arrow = i > 0 ? `<span style="color:${dropColor}">â†“ ${dropPct}% ì´íƒˆ</span><br>` : '';
                    return `
                        ${arrow}
                        <div style="margin:3px 0;display:flex;align-items:center;gap:8px">
                            <span style="min-width:80px;font-size:11px">${s.label}</span>
                            <div style="background:#45475a;border-radius:4px;flex:1;height:14px;overflow:hidden">
                                <div style="background:#89b4fa;width:${barWidth}%;height:100%;border-radius:4px"></div>
                            </div>
                            <span class="value" style="min-width:30px;text-align:right">${s.sessions}</span>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                el.innerHTML = '<span style="color:#f38ba8">API ì—°ê²° ì‹¤íŒ¨: ' + e.message + '</span>';
            }
        }
    </script>
</body>
</html>

# MoodPing 토큰 사용량 계산

## 1. 기능별 토큰 사용량 (Gemini 기준)

### 감정 기록 분석 (1회)
| 구분 | 토큰 수 | 비고 |
|------|---------|------|
| 시스템 프롬프트 | ~150 | CBT 상담사 역할 |
| 사용자 프롬프트 | ~200 | 이모지+강도+메모 |
| **입력 합계** | **~350** | |
| 출력 | ~300 | 3문단 분석 |
| **총 사용** | **~650** | 1회 기록당 |

### 주간 리포트 (1회)
| 구분 | 토큰 수 | 비고 |
|------|---------|------|
| 시스템 프롬프트 | ~80 | 간소화됨 |
| 사용자 프롬프트 | ~400 | 10건 기록+감정분포 |
| **입력 합계** | **~480** | |
| 출력 | ~250 | 2-3문단 요약 |
| **총 사용** | **~730** | 1회 리포트당 |

---

## 2. Google Gemini 무료 한도 ($300 크레딧)

- **TPM (Tokens Per Minute)**: 250,000
- **RPM (Requests Per Minute)**: 5~15 (모델별 상이)
- **RPD (Requests Per Day)**: 250~1,000 (모델별 상이)

### 일일 사용량 시나리오
| 시나리오 | 감정기록 | 리포트 | 총 토큰 | 비고 |
|----------|----------|--------|---------|------|
| 1일 5회 기록 + 1회 리포트 | 3,250 | 730 | ~4,000 | 여유 |
| 1일 50회 기록 + 5회 리포트 | 32,500 | 3,650 | ~36,000 | 여유 |
| 1일 200회 기록 + 20회 리포트 | 130,000 | 14,600 | ~145,000 | TPM 내 |

**결론**: 토큰 한도는 충분함. 문제는 **타임아웃** 또는 **RPM/RPD 제한**.

---

## 3. 주간 리포트 실패 원인 (확인됨)

- **원인**: `Gemini 호출 타임아웃 (20.0s)` — 주간 리포트 생성이 20초 초과
- **해결**: 
  1. `.env`에서 `LLM_TIMEOUT_SECONDS=120` 설정
  2. **서버 수동 재시작** (uvicorn --reload는 .env 변경을 감지하지 않음)
  3. 프롬프트 간소화로 생성 시간 단축

---

## 4. 권장 설정 (.env)

```
LLM_TIMEOUT_SECONDS=120
LLM_MAX_TOKENS=8192
```

주간 리포트는 2-3문단으로 간소화되어 8192로 충분합니다.

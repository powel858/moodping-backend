<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodPing - ì£¼ê°„ ë¦¬í¬íŠ¸</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav-bar">
            <a href="/" class="nav-logo">Mood<span>Ping</span></a>
            <div class="nav-actions" id="nav-actions"></div>
        </nav>

        <!-- Back -->
        <button class="btn-back" onclick="window.location.href='/'">â† ëŒì•„ê°€ê¸°</button>

        <!-- Report Header -->
        <div class="report-header">
            <h1>ğŸŒ¿ ì´ë²ˆ ì£¼ ë§ˆìŒ ë¦¬í¬íŠ¸</h1>
            <p class="report-period" id="report-period">ë¡œë”© ì¤‘...</p>
        </div>

        <!-- Loading -->
        <div id="report-loading" class="text-center" style="padding:40px 0">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>ë¦¬í¬íŠ¸ë¥¼ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...</p>
            </div>
        </div>

        <!-- Report Content (hidden until loaded) -->
        <div id="report-content" class="hidden">
            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="stat-count">-</div>
                    <div class="stat-label">ì´ ê¸°ë¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-intensity">-</div>
                    <div class="stat-label">í‰ê·  ê°•ë„</div>
                </div>
            </div>

            <!-- Mood Distribution -->
            <div class="card">
                <div class="report-section">
                    <div class="report-section-title">ê°ì • ë¶„í¬</div>
                    <div id="mood-distribution"></div>
                </div>
            </div>

            <!-- AI Summary -->
            <div class="ai-summary-card" id="ai-summary-card">
                <h3>ğŸ’Œ AI ìƒë‹´ì‚¬ì˜ ì£¼ê°„ ë¶„ì„</h3>
                <div class="ai-summary-text" id="ai-summary-text">
                    ë¶„ì„ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
                </div>
            </div>

            <div class="mt-16">
                <a href="/record" class="btn-primary">ì˜¤ëŠ˜ì˜ ê°ì • ê¸°ë¡í•˜ëŸ¬ ê°€ê¸°</a>
            </div>
            <div class="mt-12">
                <a href="/" class="btn-outline">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
        </div>

        <!-- Error -->
        <div id="report-error" class="hidden text-center" style="padding:40px 0">
            <p style="font-size:48px;margin-bottom:16px">ğŸ˜¿</p>
            <p style="color:var(--text-secondary)">ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</p>
            <button class="btn-outline mt-16" onclick="loadReport()">ë‹¤ì‹œ ì‹œë„</button>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        const POSITIVE_MOODS = ['happy', 'excited', 'thrilled', 'love', 'confident', 'calm'];
        const NEUTRAL_MOODS  = ['numb', 'tired'];

        function getMoodClass(labelKo) {
            const positiveLabels = ['ê¸°ì¨','ì‹ ë‚¨','ì„¤ë ˜','ì‚¬ë‘','ìì‹ ê°','í‰ì˜¨'];
            const neutralLabels  = ['ë¬´ê°ê°','í”¼ê³¤'];
            if (positiveLabels.includes(labelKo)) return 'positive';
            if (neutralLabels.includes(labelKo))  return 'neutral';
            return 'negative';
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderNavAuth(document.getElementById('nav-actions'));
            loadReport();
        });

        async function loadReport() {
            document.getElementById('report-loading').classList.remove('hidden');
            document.getElementById('report-content').classList.add('hidden');
            document.getElementById('report-error').classList.add('hidden');

            try {
                const res = await fetch('/api/reports/weekly/latest', {
                    headers: getAuthHeaders()
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                document.getElementById('report-period').textContent =
                    `${formatDate(data.week_start)} ~ ${formatDate(data.week_end)}`;

                document.getElementById('stat-count').textContent = data.record_count;
                document.getElementById('stat-intensity').textContent =
                    data.avg_intensity ? `${data.avg_intensity.toFixed(1)}` : '-';

                renderDistribution(data.mood_distribution, data.record_count);

                if (data.summary_text) {
                    document.getElementById('ai-summary-text').innerHTML =
                        data.summary_text.replace(/\n/g, '<br>');
                } else {
                    document.getElementById('ai-summary-text').textContent =
                        'AI ë¶„ì„ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                }

                document.getElementById('report-loading').classList.add('hidden');
                document.getElementById('report-content').classList.remove('hidden');

            } catch (e) {
                console.error('ë¦¬í¬íŠ¸ ë¡œë”© ì‹¤íŒ¨:', e);
                document.getElementById('report-loading').classList.add('hidden');
                document.getElementById('report-error').classList.remove('hidden');
            }
        }

        function renderDistribution(distribution, totalCount) {
            const el = document.getElementById('mood-distribution');
            if (!distribution || distribution.length === 0) {
                el.innerHTML = '<p class="text-muted">ë°ì´í„° ì—†ìŒ</p>';
                return;
            }

            const maxCount = Math.max(...distribution.map(d => d.count));

            el.innerHTML = distribution.map(d => {
                const width = Math.max(15, Math.round((d.count / maxCount) * 100));
                const moodClass = getMoodClass(d.label_ko);
                return `
                    <div class="mood-bar-item">
                        <span class="mood-bar-emoji">${d.emoji}</span>
                        <div class="mood-bar-track">
                            <div class="mood-bar-fill ${moodClass}" style="width:${width}%">
                                ${d.label_ko}
                            </div>
                        </div>
                        <span class="mood-bar-label">${d.count}íšŒ</span>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            const month = d.getMonth() + 1;
            const day = d.getDate();
            const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
            const dayName = dayNames[d.getDay()];
            return `${month}/${day} (${dayName})`;
        }
    </script>
</body>
</html>
